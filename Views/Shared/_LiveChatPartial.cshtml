@* _LiveChatPartial.cshtml *@

<!-- N√∫t m·ªü chat n·ªïi -->
<div id="chatFab" style="position: fixed; bottom: 32px; right: 32px; z-index: 9999;">
    <button id="chatFabBtn" type="button" class="btn btn-warning rounded-circle shadow-lg position-relative"
            style="width:64px; height:64px;" tabindex="0" aria-label="M·ªü chat">
        <i class="bi bi-chat-dots" style="font-size: 2rem; pointer-events:none;"></i>
        <span id="chatBadge"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="font-size: 1em; display:none;">0</span>
    </button>
</div>

<!-- H·ªôp tho·∫°i chat -->
<div id="liveChatBox" class="card shadow-sm position-fixed"
     style="bottom: 110px; right: 32px; width: 340px; z-index: 9999; display:none;">
    <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-chat-dots"></i> H·ªó tr·ª£ tr·ª±c tuy·∫øn</span>
        <button type="button" class="btn btn-sm btn-light" onclick="closeChatBox()">√ó</button>
    </div>
    <div class="card-body p-2" style="height: 260px; overflow-y: auto;" id="chatMessages">
        <div class="text-muted small mb-2">Xin ch√†o! B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?</div>
    </div>
    <div class="card-footer p-2">
        <form onsubmit="sendChatMessage(event)">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn..."
                       autocomplete="off" />
                <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
            </div>
        </form>
    </div>
</div>

<!-- N√∫t chuy·ªÉn dark/light mode n·ªïi, h√¨nh tr√≤n, n·∫±m tr√™n livechat -->
<div id="themeFab" style="position: fixed; bottom: 180px; right: 32px; z-index: 10000;">
    <button id="toggle-global-theme" type="button" class="btn rounded-circle shadow-lg"
            style="width:56px; height:56px; background: #7c3aed; color: #fff; border:none; display:flex; align-items:center; justify-content:center; font-size:1.7rem;"
            title="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi">
        <span id="theme-icon">üåô</span>
    </button>
</div>

<!-- Script x·ª≠ l√Ω chat -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatFabBtn = document.getElementById('chatFabBtn');
        const chatBox = document.getElementById('liveChatBox');
        const chatBadge = document.getElementById('chatBadge');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        let chatUnread = 0;

        if (!chatFabBtn || !chatBox) {
            console.warn("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ chat. Ki·ªÉm tra ID trong HTML.");
            return;
        }

        chatFabBtn.addEventListener('click', function () {
            chatBox.style.display = 'block';
            chatFabBtn.style.display = 'none';
            chatUnread = 0;
            chatBadge.style.display = 'none';
        });

        window.closeChatBox = function () {
            chatBox.style.display = 'none';
            chatFabBtn.style.display = 'block';
        }

        window.sendChatMessage = function (e) {
            e.preventDefault();
            const msg = chatInput.value.trim();
            if (!msg) return;

            const userMsg = document.createElement('div');
            userMsg.className = 'text-end mb-1';
            userMsg.innerHTML = `<span class="badge bg-primary">${msg}</span>`;
            chatMessages.appendChild(userMsg);
            chatInput.value = '';

            // Ph·∫£n h·ªìi m·∫´u c√≥ ƒëi·ªÅu ki·ªán
            setTimeout(() => {
                const botMsg = document.createElement('div');
                botMsg.className = 'text-start mb-1';

                let response = 'C·∫£m ∆°n b·∫°n! Nh√¢n vi√™n s·∫Ω li√™n h·ªá s·ªõm.';

                const lowerMsg = msg.toLowerCase();

                if (lowerMsg.includes('shop ·ªü ƒë√¢u')) {
                    response = 'Shop ·ªü T√¢n Ph√∫, TP.HCM nh√©!';
                } else if (lowerMsg.includes('freeship') || lowerMsg.includes('free ship')) {
                    response = 'D·∫°, ƒë∆°n t·ª´ 500k s·∫Ω ƒë∆∞·ª£c freeship ·∫°.';
                } else if (lowerMsg.includes('gi·ªù') && (lowerMsg.includes('m·ªü') || lowerMsg.includes('l√†m'))) {
                    response = 'Shop m·ªü c·ª≠a t·ª´ 7h ƒë·∫øn 19h m·ªói ng√†y nha b·∫°n.';
                } else if (lowerMsg.includes('c·∫£m ∆°n')) {
                    response = 'B·∫°n qu√° l·ªãch s·ª± lu√¥n ƒë√≥ ü•∞. R·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ b·∫°n!';
                }

                botMsg.innerHTML = `<span class="badge bg-light text-dark">${response}</span>`;
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                chatUnread++;
                chatBadge.innerText = chatUnread;
                chatBadge.style.display = 'inline-block';
            }, 700);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        const themeBtn = document.getElementById('toggle-global-theme');
        const themeIcon = document.getElementById('theme-icon');
        themeBtn.onclick = function() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            themeIcon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        };
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.textContent = '‚òÄÔ∏è';
        } else {
            themeIcon.textContent = 'üåô';
        }
    });
</script>
<link rel="stylesheet" href="~/css/livechat-theme.css" />
